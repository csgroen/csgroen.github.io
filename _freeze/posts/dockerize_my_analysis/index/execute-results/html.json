{
  "hash": "508d422cc6ec9c5edcac5e85700fc014",
  "result": {
    "markdown": "---\ntitle: \"Dockerizing my R environment for reproducibility\"\ndescription: \"Are you tired of package updates changing your outputs? This one is for you\"\nimage: meme.png\nauthor: \"Clarice S Groeneveld\"\ncategories:\n    - r\n    - tutorial\n    - docker\ndate: \"2 May 2022\"\n---\n\n## The problem\n\nI love working in R because they make data analysis incredibly convenient. But guarding my analyses against package updates has always been a mixed bag. *We're looking at you, `DiffBind`*.\n\nI've known about `docker` for a while, but I always considered it the ***nuclear option*** for reproducibility: effective, but complicated and possibly a time-destroyer.\n\nSo I decided to give `renv` a try. It worked well locally during development, but the problem revealed itself when I tried sharing my analysis with my lab mates to test its \"reproducibility status\". It was a complex analysis that loaded many packages and their complex dependency trees. It took forever to get up and running in their computers, and required them to Linux libraries making the whole process more than I'd bargained for.\n\nSo I thought: \"fine, I'll try docker\". And I think I figured out the magic formula: `docker` + `renv` + R scripts = beautiful reproducibility baby.\n\n## Docker + renv\n\nFor this to work, you'll need to [install docker](https://www.docker.com/get-started/) and `renv`:\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"renv\")\n```\n:::\n\nOf course, this works better with Rstudio, but should work regardless. We'll make a simple analysis here so that this post itself is reproducible.\n\nFirst, I'll create a new directory for my project. In the example, we'll call it, creatively, \"example\".\n\n### Minimal reproducible script example\n\nFirst, a note:\n\n> Of course for a project of the complexity of this example, all you'd need is an .Rmd (or .qmd 😉) knit into an html. But analyses can get quite complex, and everything I wrote here I have tested in a much more complex real life example I used to organize my code for publication.\n\nNow, let's create a little analysis:\n\n::: {.cell}\n\n```{.r .cell-code}\ndir.create(\"example\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in dir.create(\"example\"): 'example' already exists\n```\n:::\n:::\n\nInside this folder, we'll add all our analysis scripts. In this case, there will be only one: \"sleepytime.R\".\n\nLet's make a fun animal plot: how long to mammals sleep?\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ ggplot2 3.3.5     ✔ purrr   0.3.4\n✔ tibble  3.1.6     ✔ dplyr   1.0.9\n✔ tidyr   1.2.0     ✔ stringr 1.4.0\n✔ readr   2.1.2     ✔ forcats 0.5.1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\n```\n:::\n\n```{.r .cell-code}\ndata(\"msleep\")\nmsleep2 <- msleep %>%\n    select(name, vore, sleep_total) %>%\n    filter(!is.na(vore))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsleepiest <- top_n(msleep2, 5, sleep_total) %>% .[c(1,3,5),]\nleast_sleepy <- top_n(msleep2, -3, sleep_total)\nmiddle <- msleep2 %>% filter(name %in% c(\"Dog\", \"Human\", \"Macaque\"))\n\nannots <- bind_rows(sleepiest, least_sleepy, middle)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggbeeswarm)\nlibrary(ggrepel)\nggplot(msleep2, aes(vore, fill = vore, sleep_total)) +\n    geom_violin(alpha = 0.5) +\n    geom_quasirandom(size = 1) +\n    geom_text_repel(aes(label = name), size = 3, data = annots, hjust = 0, vjust = 1) +\n    stat_summary(fun = median, geom = \"crossbar\", width = 0.6, size = 0.2) +\n    labs(x = \"Feeding behavior (vore)\", y = \"Total sleep per night (hours)\") +\n    guides(fill = \"none\") +\n    theme_light()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/sleepytime-1.png){width=672}\n:::\n:::\n\nWe'll add the results of this *very complex analysis* to a script (`sleep.R`), and then activate and freeze our environment.\n\n::: {.cell}\n\n```{.r .cell-code}\nrenv::activate()\n# run script\nrenv::snapshot() # this might take a while\n```\n:::\n\nYou'll then have the file you need, the `renv.lock` that has all the packages needed. You can download the project files from [Github](https://github.com/csgroen/blog_example).\n\n### Creating our docker\n\nNow we need to create our docker file. There's a lot more information about it [here](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/) and a cheat sheet on docker [here](https://collabnix.com/docker-cheatsheet/). But here's how I think is easiest to do for R reproducible analyses.\n\nMy R docker philosophy is that we keep code and data separate from our environment. The **docker will only contain the environment to reproduce the analysis**. **The code and data will be mounted into the docker when it is run**. This means you can still modify the code once the docker image has been built and don't need to build it again every time, as long as you didn't add any new dependencies in the new code. This will greatly simplify our lives, while still ensuring full reproducibility of results.\n\nThat being said, time to assemble the `Dockerfile` and build our image.\n\nFor all R projects, look no further than the [Rocker project](https://www.rocker-project.org/images/) for all your base image needs. What is the best version will depend on this project, but my general direction is: if you use tidyverse anywhere, use the tidyverse image. Otherwise, use the rstudio image to have a GUI into your environment.\n\nNow, make sure you take a rocker image with the same R version as you. Then, let's do our Dockerfile:\n\n::: {.cell}\n\n```{.bash .cell-code}\nFROM rocker/tidyverse:4.2.0\n# your renv version\nENV RENV_VERSION=0.15.4\nRUN apt-get update\n# install any Unix libraries after this, e.g. RUN apt-get update && apt-get install cmake\nRUN R \"install.packages('remotes', repos = repos = c(CRAN = 'https://cloud.r-project.org')\"\nRUN R \"remotes::install_github('rstudio/renv@${RENV_VERSION}')\"\nWORKDIR /project\nCOPY renv.lock renv.lock\nRUN R \"renv::restore()\"\n```\n:::\n\nWrite this to a file called Dockerfile in the directory where your analysis is (you'll see it included if you downloaded the project).\n\nNow navigate to the directory in the terminal and build it (this will take a while):\n\n::: {.cell}\n\n```{.bash .cell-code}\ndocker build -t csgroen/blog_example .\n```\n:::\n\nMake sure you give it a relevant name under the `-t` (tag) flag. Here, I used my username on DockerHub and a name relevant to this post, i.e. `username/image_name`, so I can push this later to share.\n\nAnd that's it, your environment is dockerized!\n\nIf you'd like to download the one I just made instead of building it, just pull it from Docker Hub:\n\n::: {.cell}\n\n```{.bash .cell-code}\ndocker pull csgroen/blog_example\n```\n:::\n\n### Running the docker\n\nBefore we share it with the world, let's re-run your analysis.\n\n::: {.cell}\n\n```{.bash .cell-code}\ndocker run --rm \\\n-v path/to/example:/home/rstudio/project \\\n-p 8787:8787 \\\n-e PASSWORD=somepassword \\\n-e USERID=$UID \\\ncsgroen/blog_example\n```\n:::\n\nHere, we are mounting the \"`example`\" directory into the \"`project`\" directory of our image and preparing the password and username so we can use Rstudio server to connect to the image.\n\nMake sure you use the absolute `path/to/example`, e.g. `/home/myuser/Downloads/example.`\n\nOnce you run this, you'll see this message, or something very similar:\n\n::: {.cell}\n\n```{.bash .cell-code}\n[s6-init] making user provided files available at /var/run/s6/etc...exited 0.\n[s6-init] ensuring user provided files have correct perms...exited 0.\n[fix-attrs.d] applying ownership & permissions fixes...\n[fix-attrs.d] done.\n[cont-init.d] executing container initialization scripts...\n[cont-init.d] 01_set_env: executing... \nskipping /var/run/s6/container_environment/HOME\nskipping /var/run/s6/container_environment/PASSWORD\nskipping /var/run/s6/container_environment/RSTUDIO_VERSION\n[cont-init.d] 01_set_env: exited 0.\n[cont-init.d] 02_userconf: executing... \ndeleting the default user\ncreating new rstudio with UID 1001\nuseradd: warning: the home directory /home/rstudio already exists.\nuseradd: Not copying any file from skel directory into it.\n[cont-init.d] 02_userconf: exited 0.\n[cont-init.d] done.\n[services.d] starting services\n[services.d] done.\n```\n:::\n\nThis means Rstudio server is ready with your environment and your mounted data. Open your browser to `localhost:8787`. You'll see this:\n\n![](rstudio.png){fig-alt=\"rstudio server\"}\n\nSign-in with the credentials we created on docker run:\n\n> **Username:** rstudio\n>\n> **Password:** somepassword\n\nYou'll be signed into something like this:\n\n![](rstudio_open.png){fig-alt=\"Rstudio server after sign-in\"}\n\nSee our project folder in the Files. Navigate there and you'll see our sleep.R script. Open it and run it.\n\n![](run_script.png)\n\nAnd we're done: we've been able to run the same analysis in the same environment we had when we wrote it.\n\n### Sharing\n\nNow that everything works, we can push our docker, and add the example (with the code and data) to Github. In this minimal example, we don't have any additional data other than the script, but you could add that as well.\n\nCheck [these instructions](https://docs.docker.com/docker-hub/repos/#:~:text=To%20push%20an%20image%20to,docs%2Fbase%3Atesting%20).) to push to Docker Hub.\n\nAnd then add your code/data to a repo on Github, [like I did here](https://github.com/csgroen/blog_example).\n\nMake a README like this to teach others how to reproduce the analysis:\n\n::: {.cell}\n\n```{.bash .cell-code}\n# Minimal example of reproducible analysis\n\nTo run the analysis contained in `sleep.R` in the same environment it was created:\n\n1.  Pull the docker image from DockerHub:\n\ndocker pull csgroen/blog_example\n\n2.  Download this repo (e.g. git clone csgroen/blog_example)\n\n3.  Mount the repo into the docker image and run:\n\ndocker run --rm\\\n-v /path/to/example:/home/rstudio/project\\\n-p 8787:8787\\\n-e PASSWORD=somepassword\\\n-e USERID=\\$UID\\\ncsgroen/blog_example\n\nwhere /path/to/example is the absolute path to the repo.\n\n3.  Open Rstudio server by opening your browser and navigating to:\n\nlocalhost:8787\n\n4.  Sign-in username: rstudio password: somepassword.\n\n5.  Navigate to `/project`, open the `sleep.R` script and run it.\n\n```\n:::\n\nNow celebrate achieving the gold standard of reproducibility, something very few are even attempting to do.\n\n![](https://assets.teenvogue.com/photos/55b271a774dfbc51751ef24a/master/w_1600%252Cc_limit/taydance4.gif){fig-align=\"center\"}\n\nFeel free to open issues and hit me up on Github if you have any problems/questions! Toodaloo 👋🏻",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": null
  }
}